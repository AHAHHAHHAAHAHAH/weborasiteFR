---
import type { SiteConfig } from "../lib/siteConfig";
const { cfg } = Astro.props as { cfg: SiteConfig };

const navItems = cfg.navigation.items || [];
const hasHome = navItems.some((i: any) => i.id === "" || i.id === "/");
const finalItems = hasHome ? navItems : [{ id: "", label: "La Base" }, ...navItems];
---

<div id="drawerBackdrop" class="drawer-backdrop"></div>

<aside id="drawerPanel" class="drawer-panel">
  
  <div class="drawer-bg-watermark" style={`background-image: url('${cfg.brand.logoPath}')`}></div>

  <div class="drawer-header">
    <div class="drawer-brand">
      <strong class="drawer-title">{cfg.navigation.drawerTitle}</strong>
    </div>
    <button id="closeDrawer" class="drawer-close-btn" aria-label="Chiudi">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <nav class="drawer-nav">
    {finalItems.map((item: any, index: number) => {
      const href = item.id ? `/${item.id}` : "/";
      
      return (
        <a href={href} class="drawer-link" style={`--delay: ${index * 0.1}s;`}>
          <span class="link-label">{item.label}</span>
          <span class="link-arrow">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </span>
        </a>
      );
    })}
  </nav>

  <div class="drawer-footer">
    <div class="footer-kicker">Linee Dirette</div>
    
    <div class="contact-hub">
      <a href={`https://wa.me/${cfg.contacts.phoneE164}`} target="_blank" rel="noopener noreferrer" class="hub-link wa-lane">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
        <div class="hub-text">
          <span class="hub-type">WhatsApp</span>
          <span class="hub-value">{cfg.contacts.phoneDisplay || 'Scrivici ora'}</span>
        </div>
      </a>

      <a href={`mailto:${cfg.contacts.email}`} class="hub-link mail-lane">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
        <div class="hub-text">
          <span class="hub-type">eMail</span>
          <span class="hub-value">{cfg.contacts.email}</span>
        </div>
      </a>
    </div>
  </div>

</aside>

<style>
  /* ==========================================
     BACKDROP
     ========================================== */
  .drawer-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    opacity: 0; pointer-events: none;
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 60;
  }
  .drawer-backdrop.is-open { opacity: 1; pointer-events: auto; }

  /* ==========================================
     IL PANNELLO FLUTTUANTE
     ========================================== */
  .drawer-panel {
    position: fixed;
    top: 16px; right: 16px; bottom: 16px;
    width: min(420px, calc(100vw - 32px));
    background: linear-gradient(145deg, rgba(15,15,15,0.85) 0%, rgba(5,5,5,0.98) 100%);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 24px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 40px rgba(179, 91, 91, 0.08);
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    z-index: 61;
    display: flex; flex-direction: column;
    overflow: hidden;
    
    opacity: 0; pointer-events: none;
    transform: translateX(40px) scale(0.98);
    transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
  }
  
  .drawer-panel.is-open {
    opacity: 1; pointer-events: auto;
    transform: translateX(0) scale(1);
  }

  /* ==========================================
     IL LOGO IN BACKGROUND (La Magia)
     ========================================== */
  .drawer-bg-watermark {
    position: absolute;
    top: 50%; left: 50%;
    width: 150%; height: 150%;
    transform: translate(-50%, -50%);
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.03; /* Super delicato */
    filter: grayscale(100%) blur(2px);
    pointer-events: none;
    z-index: 0; /* Dietro tutto */
    animation: slowSpin 60s linear infinite;
  }

  @keyframes slowSpin {
    from { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
    to { transform: translate(-50%, -50%) rotate(360deg) scale(1.1); }
  }

  /* Tutte le sezioni sopra il watermark devono avere z-index */
  .drawer-header, .drawer-nav, .drawer-footer { position: relative; z-index: 10; }

  /* ==========================================
     HEADER DEL MENU (Psicologico)
     ========================================== */
  .drawer-header {
    padding: 32px 32px 24px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  
  .drawer-title { 
    font-size: 0.85rem; font-weight: 700; 
    letter-spacing: 0.2em; color: var(--accent2); text-transform: uppercase; 
  }

  .drawer-close-btn {
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
    color: var(--muted); border-radius: 50%;
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .drawer-close-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); transform: rotate(90deg); }

  /* ==========================================
     LA NAVIGAZIONE (Senza Numeri, Pura)
     ========================================== */
  .drawer-nav {
    flex-grow: 1; padding: 32px;
    display: flex; flex-direction: column; gap: 8px; /* Gap ridotto per farli sembrare un blocco unico */
    overflow-y: auto; scrollbar-width: none;
  }
  .drawer-nav::-webkit-scrollbar { display: none; }

  .drawer-link {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px; border-radius: 16px;
    background: transparent;
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    
    opacity: 0; transform: translateX(20px);
  }
  
  .drawer-panel.is-open .drawer-link {
    animation: slideInLink 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    animation-delay: var(--delay);
  }
  @keyframes slideInLink { to { opacity: 1; transform: translateX(0); } }

  .drawer-link:hover {
    background: rgba(255,255,255,0.03);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
    transform: translateX(8px);
  }

  .link-label { font-size: 1.5rem; font-weight: 700; color: var(--muted); letter-spacing: -0.02em; transition: color 0.3s; }
  .drawer-link:hover .link-label { color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); }

  .link-arrow {
    color: var(--accent);
    opacity: 0; transform: translateX(-15px);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .drawer-link:hover .link-arrow { opacity: 1; transform: translateX(0); }

  /* ==========================================
     FOOTER DEL MENU (Hub Contatti)
     ========================================== */
  .drawer-footer {
    padding: 24px 32px 32px;
    border-top: 1px solid rgba(255,255,255,0.04);
    background: rgba(0,0,0,0.3);
  }
  .footer-kicker { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.2em; color: var(--muted); margin-bottom: 16px; }
  
  .contact-hub { display: flex; flex-direction: column; gap: 12px; }
  
  .hub-link {
    display: flex; align-items: center; gap: 16px;
    padding: 16px; border-radius: 16px;
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.03);
    color: var(--muted); text-decoration: none;
    transition: all 0.3s ease;
  }
  
  .hub-link:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); border-color: rgba(255,255,255,0.08); }
  
  .wa-lane:hover { color: #25D366; /* Verde WhatsApp psicologico */ }
  .mail-lane:hover { color: var(--accent2); }

  .hub-text { display: flex; flex-direction: column; line-height: 1.3; }
  .hub-type { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.7; }
  .hub-value { font-size: 1rem; font-weight: 600; color: var(--text); }
  .hub-link:hover .hub-value { color: inherit; }

  /* ==========================================
     MOBILE COMPATIBILITY
     ========================================== */
  @media (max-width: 768px) {
    .drawer-panel { top: 8px; right: 8px; bottom: 8px; width: calc(100vw - 16px); }
    .drawer-header { padding: 24px; }
    .drawer-nav { padding: 24px 16px; gap: 4px; }
    .drawer-link { padding: 16px; }
    .link-label { font-size: 1.35rem; }
    .drawer-footer { padding: 24px; }
    .hub-link { padding: 12px; }
  }
</style>

<script type="module">
  const b = document.getElementById("drawerBackdrop");
  const p = document.getElementById("drawerPanel");
  const x = document.getElementById("closeDrawer");
  const links = document.querySelectorAll(".drawer-link");

  if (b && p && x) {
    function open() {
      b.classList.add('is-open');
      p.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    function close() {
      b.classList.remove('is-open');
      p.classList.remove('is-open');
      document.body.style.overflow = '';
    }

    window.addEventListener("webora:drawer:open", open);
    window.addEventListener("webora:drawer:close", close);
    
    b.addEventListener("click", close);
    x.addEventListener("click", close);
    window.addEventListener("keydown", (e) => { if (e.key === "Escape") close(); });

    links.forEach(link => {
      link.addEventListener("click", close);
    });
  }
</script>