---
import type { SiteConfig } from "../../lib/siteConfig";
const { cfg, section } = Astro.props as { cfg: SiteConfig; section: any };

const data = cfg.preventivo;
const preventivoJson = JSON.stringify(data.options);

const defaultType = data.options.projectType[0].id;
const defaultSizes = (data.options.size as any)[defaultType];
const defaultSpeeds = (data.options.speed as any)[defaultType];
---

<section id={section.id} class="section">
  <div class="wrap">
    
    <div class="reveal" style="text-align: center; max-width: 700px; margin: 0 auto 50px;">
      <span class="kicker">{section.kicker}</span>
      <h2>{data.title}</h2>
      <p style="font-size: 1.2rem; color: var(--muted); line-height: 1.6;">{data.subtitle}</p>
    </div>

    <div class="grid cols-2" style="gap: 60px; align-items: start;">
      
      <div class="reveal card" style="padding: 40px;">
        <form id="calcForm" style="display: flex; flex-direction: column; gap: 32px;">
          
          <div class="input-group">
            <label>1. Obiettivo del Progetto</label>
            <select id="calcType" class="premium-select">
              {data.options.projectType.map((opt:any) => (
                <option value={opt.id}>{opt.label}</option>
              ))}
            </select>
          </div>

          <div class="input-group">
            <label>2. Struttura e Dimensione</label>
            <select id="calcSize" class="premium-select">
              {defaultSizes.map((opt:any) => (
                <option value={opt.id}>{opt.label}</option>
              ))}
            </select>
          </div>

          <div class="input-group">
            <label>3. Tempistiche di Consegna</label>
            <select id="calcSpeed" class="premium-select">
              {defaultSpeeds.map((opt:any) => (
                <option value={opt.id}>{opt.label}</option>
              ))}
            </select>
          </div>

        </form>
      </div>

      <div class="reveal delay-1" style="display: flex; flex-direction: column; justify-content: flex-start; gap: 24px;">
        
        <div style="background: rgba(179, 91, 91, 0.1); border: 1px solid rgba(179, 91, 91, 0.3); border-radius: 16px; padding: 20px 24px;">
          <p style="font-size: 0.85rem; color: var(--accent2); line-height: 1.5; margin: 0; font-weight: 500;">
            {data.disclaimer}
          </p>
        </div>

        <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), transparent); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 40px; position: relative; overflow: hidden;">
          
          <div style="margin-bottom: 30px;">
            <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 8px;">Stima Setup (Costo Una Tantum)</div>
            <div style="display: flex; align-items: baseline; gap: 8px;">
              <span style="font-size: 2rem; color: var(--text); font-weight: 600;">€</span>
              <span id="displaySetup" style="font-size: 4rem; font-weight: 800; line-height: 1; color: var(--text); font-variant-numeric: tabular-nums; transition: all 0.3s ease;">0</span>
            </div>
          </div>

          <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.06); margin: 30px 0;"></div>

          <div style="margin-bottom: 40px;">
            <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 12px;">Mantenimento & Supporto Continuo</div>
            
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 24px;">
              <span style="font-size: 1.2rem; color: var(--accent2); font-weight: 600;">€</span>
              <span id="displayMonthly" style="font-size: 2.8rem; font-weight: 800; line-height: 1; color: var(--accent2);">0</span>
              <span style="font-size: 1rem; color: var(--muted);">/mese</span>
            </div>

            <div class="billing-toggle-wrapper">
              <button class="billing-btn" data-plan="1">1 Mese</button>
              <button class="billing-btn" data-plan="6">6 Mesi <span class="badge">Salva</span></button>
              <button class="billing-btn active" data-plan="12">12 Mesi <span class="badge premium">Pro</span></button>
            </div>
          </div>

          <button id="applyToFormBtn" class="btn primary" style="width: 100%;">
            Prosegui con questa configurazione
          </button>
          
        </div>
      </div>

    </div>
  </div>
</section>

<style>
  .input-group label {
    font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent2); font-weight: 600; margin-bottom: 12px; display: block;
  }
  .premium-select {
    width: 100%; padding: 18px 20px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px; color: #fff; font-family: inherit; font-size: 1.05rem; cursor: pointer;
    appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat; background-position: right 20px center; background-size: 16px; transition: all 0.3s ease;
  }
  .premium-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(179, 91, 91, 0.15); }
  .premium-select option { background: var(--panel); color: #fff; }

  /* STILI TOGGLE COMPATTO IDENTICO A PREZZI */
  .billing-toggle-wrapper {
    display: inline-flex;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 99px;
    padding: 6px;
    gap: 4px;
  }
  .billing-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 0.95rem;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 99px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .billing-btn.active {
    background: rgba(255,255,255,0.1);
    color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .billing-btn:hover:not(.active) { color: #fff; }
  
  .badge { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.1); color: #fff; }
  .badge.premium { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: var(--bg); font-weight: 700; }

  @media (max-width: 768px) {
    .billing-toggle-wrapper { display: flex; width: 100%; justify-content: space-between; }
    .billing-btn { padding: 10px 12px; font-size: 0.85rem; flex: 1; }
    .badge { display: none; }
  }
</style>

<script define:vars={{ preventivoJson }}>
  document.addEventListener('DOMContentLoaded', () => {
    const opts = JSON.parse(preventivoJson);
    
    const typeEl = document.getElementById('calcType');
    const sizeEl = document.getElementById('calcSize');
    const speedEl = document.getElementById('calcSpeed');
    
    const displaySetup = document.getElementById('displaySetup');
    const displayMonthly = document.getElementById('displayMonthly');
    const applyBtn = document.getElementById('applyToFormBtn');
    
    const billingBtns = document.querySelectorAll('.billing-btn');
    let currentPlan = "12"; // Default a 12 mesi

    billingBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        billingBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPlan = btn.getAttribute('data-plan');
        calculate();
      });
    });

    function updateDropdowns(selectedType) {
      sizeEl.innerHTML = '';
      speedEl.innerHTML = '';
      opts.size[selectedType].forEach(opt => sizeEl.add(new Option(opt.label, opt.id)));
      opts.speed[selectedType].forEach(opt => speedEl.add(new Option(opt.label, opt.id)));
    }

    function calculate() {
      const currentType = typeEl.value;
      const typeData = opts.projectType.find(t => t.id === currentType);
      const sizeData = (opts.size[currentType] || []).find(s => s.id === sizeEl.value);
      const speedData = (opts.speed[currentType] || []).find(s => s.id === speedEl.value);

      if(!typeData || !sizeData || !speedData) return;

      const rawSetup = (typeData.basePrice + sizeData.addon) * speedData.multiplier;
      const finalSetup = Math.round(rawSetup);
      
      const finalMonthly = typeData.monthlyPrices[currentPlan];

      displaySetup.style.opacity = '0.5';
      displaySetup.style.transform = 'scale(0.95)';
      
      setTimeout(() => {
        displaySetup.textContent = finalSetup.toLocaleString('it-IT');
        displayMonthly.textContent = finalMonthly.toString().replace('.', ',');
        displaySetup.style.opacity = '1';
        displaySetup.style.transform = 'scale(1)';
      }, 150);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const preselectedPkg = urlParams.get('pkg');
    if (preselectedPkg && Array.from(typeEl.options).some(opt => opt.value === preselectedPkg)) {
      typeEl.value = preselectedPkg;
    }

    updateDropdowns(typeEl.value);
    calculate();

    typeEl.addEventListener('change', (e) => { updateDropdowns(e.target.value); calculate(); });
    sizeEl.addEventListener('change', calculate);
    speedEl.addEventListener('change', calculate);

    if(applyBtn) {
      applyBtn.addEventListener('click', () => {
        const typeName = typeEl.options[typeEl.selectedIndex].text;
        const sizeName = sizeEl.options[sizeEl.selectedIndex].text;
        const speedName = speedEl.options[speedEl.selectedIndex].text;
        const setupPrice = displaySetup.textContent;
        const monthlyPrice = displayMonthly.textContent;

        const messageText = `Ciao Webora Studio,\n\nHo utilizzato il vostro calcolatore e vorrei procedere con questa infrastruttura:\n\n- Natura: ${typeName}\n- Complessità: ${sizeName}\n- Timeline: ${speedName}\n- Piano Abbonamento: ${currentPlan} Mesi\n\nStima Setup (Una Tantum): €${setupPrice} (a partire da)\nMantenimento Fisso: €${monthlyPrice}/mese\n\nVorrei fissare una chiamata esplorativa gratuita.`;

        const messageBox = document.getElementById('message');
        if(messageBox) {
          messageBox.value = messageText;
          messageBox.style.borderColor = "#2ecc71";
          messageBox.style.boxShadow = "0 0 0 4px rgba(46, 204, 113, 0.2)";
          messageBox.scrollIntoView({ behavior: 'smooth', block: 'center' });

          setTimeout(() => {
            messageBox.style.borderColor = "";
            messageBox.style.boxShadow = "";
          }, 2000);
        }
      });
    }
  });
</script>