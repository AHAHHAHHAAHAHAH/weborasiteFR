---
import type { SiteConfig } from "../../lib/siteConfig";
const { cfg, section } = Astro.props as { cfg: SiteConfig; section: any };
const packages = cfg.pricing?.packages || [];
const disclaimer = cfg.pricing?.disclaimer || "";

const packagesJson = JSON.stringify(packages);
---

<section id={section.id} class="section">
  <div class="wrap">
    
    <div class="reveal" style="text-align: center; max-width: 700px; margin: 0 auto 50px;">
      <span class="kicker">{section.kicker}</span>
      <h2>{section.title}</h2>
      <p style="font-size: 1.2rem; color: var(--muted); line-height: 1.6;">{section.body}</p>
      
      <div class="billing-toggle-wrapper">
        <button class="billing-btn" data-plan="1">1 Mese</button>
        <button class="billing-btn" data-plan="6">6 Mesi <span class="badge">Salva</span></button>
        <button class="billing-btn active" data-plan="12">12 Mesi <span class="badge premium">Pro</span></button>
      </div>
    </div>

    <div class="grid cols-3">
      {packages.map((pkg: any, index: number) => (
        <div class={`card reveal delay-${index % 3}`} style="padding: 40px 32px; display: flex; flex-direction: column;">
          <h3 style="font-size: clamp(1.4rem, 4vw, 1.6rem); color: var(--text);">{pkg.title}</h3>
          <p style="font-size: 0.95rem; color: var(--accent2); margin-bottom: 30px;">{pkg.subtitle}</p>
          
          <div style="margin-bottom: 20px;">
            <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 4px;">Setup Iniziale</div>
            <div style="font-size: 2.2rem; font-weight: 800; line-height: 1; color: var(--text);">
              €{pkg.basePrice}
            </div>
          </div>
          
          <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.06); margin: 20px 0;"></div>

          <div style="margin-bottom: 30px;">
            <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 4px;">Mantenimento & Supporto</div>
            <div style="display: flex; align-items: baseline; gap: 6px;">
              <span style="font-size: 1.5rem; color: var(--text); font-weight: 600;">+ €</span>
              <span class="dynamic-price" data-pkg={pkg.id} style="font-size: 2.8rem; font-weight: 800; line-height: 1; color: var(--accent2);">
                {pkg.monthlyPrices['12']}
              </span>
              <span style="font-size: 1rem; color: var(--muted);">/mese</span>
            </div>
          </div>
          
          <ul style="padding: 0; margin: 0 0 40px 0; list-style: none; display: flex; flex-direction: column; gap: 14px; flex-grow: 1;">
            {pkg.highlights.map((hl: string) => (
              <li style="display: flex; align-items: flex-start; gap: 12px; color: var(--muted); font-size: 1rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="margin-top: 3px; flex-shrink: 0;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                {hl}
              </li>
            ))}
          </ul>
          
          <a href={`/preventivi-box?pkg=${pkg.id}#preventivi`} class="btn" style="width: 100%; position: relative; z-index: 30;">
            Richiedi Info
          </a>
        </div>
      ))}
    </div>

    {disclaimer && (
      <div class="reveal delay-2" style="margin-top: 50px; text-align: center;">
        <div style="display: inline-block; max-width: 800px; padding: 24px 32px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; backdrop-filter: blur(10px);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="2" style="margin-bottom: 12px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
          <p style="font-size: 0.95rem; color: var(--muted); margin: 0; white-space: pre-line; line-height: 1.6;">
            {disclaimer}
          </p>
        </div>
      </div>
    )}

  </div>
</section>

<style>
  .billing-toggle-wrapper {
    display: inline-flex;
    flex-direction: row; /* Forza l'orizzontale */
    align-items: center;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 99px;
    padding: 6px;
    gap: 4px;
    margin-top: 30px;
    flex-wrap: nowrap; /* Vieta l'andata a capo */
  }
  .billing-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 0.95rem;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 99px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 8px;
    white-space: nowrap; /* Impedisce al testo di spezzarsi */
  }
  .billing-btn.active {
    background: rgba(255,255,255,0.1);
    color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .billing-btn:hover:not(.active) { color: #fff; }

  .badge { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.1); color: #fff; }
  .badge.premium { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: var(--bg); font-weight: 700; }

  @media (max-width: 768px) {
    .billing-toggle-wrapper { display: flex; width: 100%; justify-content: space-between; }
    .billing-btn { padding: 10px 12px; font-size: 0.85rem; flex: 1; }
    .badge { display: none; }
  }
</style>

<script define:vars={{ packagesJson }}>
  document.addEventListener('DOMContentLoaded', () => {
    const packages = JSON.parse(packagesJson);
    const btns = document.querySelectorAll('.billing-btn');
    const priceDisplays = document.querySelectorAll('.dynamic-price');

    btns.forEach(btn => {
      btn.addEventListener('click', () => {
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const plan = btn.getAttribute('data-plan'); 

        priceDisplays.forEach(display => {
          const pkgId = display.getAttribute('data-pkg');
          const pkgData = packages.find(p => p.id === pkgId);
          
          if(pkgData && pkgData.monthlyPrices) {
            const newPrice = pkgData.monthlyPrices[plan];
            
            display.style.opacity = '0';
            display.style.transform = 'translateY(-5px)';
            
            setTimeout(() => {
              display.textContent = newPrice;
              display.style.opacity = '1';
              display.style.transform = 'translateY(0)';
              display.style.transition = 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
            }, 150);
          }
        });
      });
    });
  });
</script>
